var e,t,s,r,a,i,o,n,u,d,c,m,l,p,g,h,w,y,f,v,q,b,$,j,k,x,S,_,R,I,P,E,O,T,C,D,N,M,A,B,F,W,L,U=require("path"),V=require("express"),z=require("morgan"),J=require("dotenv"),Q=require("express-rate-limit"),G=require("helmet"),H=require("express-mongo-sanitize"),Y=require("xss-clean"),K=require("hpp"),X=require("cors"),Z=require("cookie-parser"),ee=require("compression"),et=require("sharp"),es=require("multer"),er=require("mongoose"),ea=require("slugify");require("fs");var ei=require("util"),eo=require("jsonwebtoken"),en=require("crypto"),eu=require("validator"),ed=require("bcryptjs"),ec=require("nodemailer"),em=require("pug"),el=require("html-to-text"),ep=require("stripe"),eg=U.resolve(__dirname,"../../.."),eh={};eh=class extends Error{constructor(e,t){super(e),this.statusCode=t,this.status=`${t}`.startsWith("4")?"Fail":"Success",this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}};var ew={};const ey=(e,t)=>{t.status(e.statusCode).json({status:e.status,error:e,message:e.message,stack:e.stack})},ef=(e,t)=>{e.isOperational?t.status(e.statusCode).json({status:e.status,message:e.message}):t.status(500).json({status:"Error",mesage:"Something went very wrong!"})},ev=(e,t)=>{t.status(400).json({status:"Error",message:`Input id (${e.value}) is incorrect!`})},eq=(e,t)=>{let s=Object.keys(e.errorResponse.keyPattern)[0];t.status(400).json({status:"Error",message:`The input for field: ${s} (${e.errorResponse.keyValue[s]}) shoud be unique, please chose another!`})},eb=(e,t)=>{let s=Object.keys(e.errors),r={};s.forEach(t=>r[t]=e.errors[t]?.message),t.status(400).json({status:"Error",message:r})},e$=(e,t)=>{t.status(401).json({status:"Error",message:"Invalid JWT Signature!"})},ej=(e,t)=>{t.status(401).json({status:"Error",message:"Token expired"})};ew=(e,t,s,r)=>{e.statusCode=e.statusCode||500,e.status=e.status||"error",e?.name==="CastError"?ev(e,s):"TokenExpiredError"===e.name?ej(e,s):"JsonWebTokenError"===e.name?e$(e,s):e?.errorResponse?.code===11e3?eq(e,s):e?.name==="ValidationError"?eb(e,s):"production"===process.env.NODE_ENV?ey(e,s):ef(e,s)};var ek={},ex={};const eS=er.Schema({slug:{type:String},name:{required:[!0,"Tour name is required!"],minLength:[5,"Minimum length is 20 char!"],maxLength:[40,"Maximum length is 40 char!"],type:String,unique:!0,trim:!0},duration:{type:Number,required:[!0,"Duration is required"],min:[1,"Duration must be minimum 1 day!"]},difficulty:{type:String,required:[!0,"Difficulty is required"],enum:{values:["easy","difficult","medium"],message:"Difficult must be either easy, difficult or medium!"}},ratingsAverage:{type:Number,default:4.5,min:[1,"Rating must be higher than 1."],max:[5,"Rating must be below 5"]},ratingsQuantity:{type:Number,default:0},price:{type:Number,required:[!0,"Price is required"],min:[1,"Price must be minimum 1"],max:[15e3,"Price must be below 15000"]},maxGroupSize:{type:Number,required:[!0,"Max group size is required"],min:[1,"Min group size is 1"],max:[100,"Max group size is 10"],default:1},summary:{type:String,trim:!0,required:[!0,"Summary is required"],minLength:[1,"Summary  minimum length is 1"],maxLength:[255,"Summary maximum length is 255"]},description:{type:String,trim:!0,minLength:[10,"description minimum length is 10"],maxLength:[1700,"description maximum length is 700"]},imageCover:{type:String,trim:!0,required:[!0,"Image cover is required"]},images:{required:[!0,"images are required"],type:[String]},startDates:{required:[!0,"Start dates are required"],type:[Date]},priceDiscount:{type:Number,validate:{validator:function(e){this.price},message:"Discount price must be lower then ({VALUE})"}},secretTour:{type:Boolean,default:!1},startLocation:{type:{type:String,default:"Point",enum:["Point"]},coordinates:[Number],address:String,description:String},locations:[{type:{type:String,default:"Point",enum:["Point"]},cordinates:[Number],address:String,description:String,day:Number}],guides:[{type:er.Schema.ObjectId,ref:"User"}]},{toJSON:{virtuals:!0,getter:!0},toObject:{virtuals:!0,getter:!0}});eS.index({slug:1}),eS.index({price:1,ratingsAverage:-1}),eS.virtual("durationInWeeks").get(function(){return this.duration/7}),eS.virtual("reviews",{ref:"Review",foreignField:"tour",localField:"_id"}),eS.pre("save",function(e){this.slug=ea(this.name,{lower:!0}),e()}),eS.pre(/^find/,function(e){this.start=Date.now(),e()}),eS.pre(/^find/,function(e){this.populate({path:"guides"}).select("-_v"),e()}),eS.post(/^find/,function(e,t){console.log(`Query took ${this.start-Date.now()}`),t()}),eS.pre("aggregate",function(e){this.pipeline().unshift({$match:{secretTour:{$ne:!1}}}),e()}),ex=er.model("Tour",eS);var e_={};e_=e=>(t,s,r)=>{e(t,s,r).catch(r)};var eR={};eR=class{constructor(e,t){this.queryObject=e,this.query=t}filter(){let e={...this.queryObject};["page","limit","sort","fields"].forEach(t=>delete e[t]);let t=JSON.stringify(e).replace(/\b(gte|gt|lt|lte|eq|ne)\b/,e=>`$${e}`);return this.query=this.query.find(JSON.parse(t)),this}sort(){if(this.queryObject.sort){let e=this.queryObject.sort.split(",").join(" ");this.query=this.query.sort(e)}else this.query=this.query.sort("-createdAt");return this}limitFields(){if(this.queryObject.fields){let e=this.queryObject.fields.split(",").join(" ");this.query=this.query.select(e)}return this}paginate(){let e=1*this.queryObject.page||1,t=1*this.queryObject.limit||10;return this.query=this.query.skip((e-1)*t).limit(t),this}},c=e=>e_(async(t,s,r)=>{if(!await e.findByIdAndDelete(t.params.id))return r(new eh(`No document found with id ${t.params.id}!`,404));s.status(204).json({status:"success",data:null})}),m=e=>e_(async(t,s,r)=>{let a=await e.findByIdAndUpdate(t.params.id,t.body,{new:!0,runValidators:!0});if(!a)return r(new eh(`Document with id ${t.params.id} doesnt exists!`,404));s.status(200).json({status:"success",data:{data:a}})}),l=(e,t)=>e_(async(s,r,a)=>{let i=e.findById(s.params.id);t&&i.populate(t);let o=await i;if(!o)return a(new eh(`Document with id ${s.params.id} doesnt exist's!`,404));r.status(200).json({status:"success",data:{data:o}})}),p=e=>e_(async(t,s,r)=>{let a={};t.params.tourId&&(a={tour:t.params.tourId});let i=new eR(t.query,e.find(a)).filter().sort().limitFields().paginate(),o=await i.query,n=await e.countDocuments(a);s.status(200).json({status:"success",results:n,totalPages:Math.ceil(n/t.query.limit||6),data:{documents:o}})});var eI={},eP=U.resolve(__dirname,"../../../utils");eI=function(e){file.unlink(`${eP}/public/img/tours/${e}`,t=>{t&&console.error(`Fail to delete file on path: ${e}`)})};const eE=es.memoryStorage();e=es({storage:eE,fileFilter:(e,t,s)=>{t.mimetype.startsWith("image")?s(null,!0):s(new eh("Only images are supported",400),!1)}}).fields([{name:"imageCover",maxCount:1},{name:"images",maxCount:3}]),t=e_(async(e,t,s)=>{if(!e.files.imageCover&&!e.files.images)return s();e.files.imageCover&&(e.body.imageCover=`tour-${e.params.tourId}-${Date.now()}-cover.jpeg`,await et(e.files.imageCover[0].buffer).resize(2e3,1333).toFormat("jpeg").jpeg({quality:90}).toFile(`public/img/tours/${e.body.imageCover}`)),e.files.images&&(e.body.images=[],await Promise.all(e.files.images.map(async(t,s)=>{let r=`tour-${e.params.tourId}-${Date.now()}-${s+1}.jpeg`;await et(t.buffer).resize(2e3,1333).toFormat("jpeg").jpeg({quality:90}).toFile(`public/img/tours/${r}`),e.body.images.push(r)}))),s()}),s=c(ex),r=l(ex,{path:"reviews",select:"-tour"}),a=p(ex),i=e_(async(e,t,s)=>{let r,a,i;let o=JSON.parse(e.body.tour);if(e.body.images&&(o?.images&&(r={...o.images}),o.images=e.body.images),e.body.imageCover&&(o?.imageCover&&(a=o.imageCover),o.imageCover=e.body.imageCover),!(i=o._id?await ex.findByIdAndUpdate(o._id,o,{new:!0,runValidators:!0}):await ex.create(o)))return e.body?.images.forEach(e=>eI(e)),e.body?.imageCover&&eI(e.body.imageCover),s(new eh(`There is no tour with id ${e.params.id}`,404));r?.forEach?.(e=>eI(e)),a&&eI(a),t.status(o._id?200:201).json({status:"success",data:{document:i}})}),o=async(e,t,s)=>{e.query={limit:"5",sort:"price,-raitingsAverage"},e.query.fields="price,name,difficulty,ratingsAverage",s()},n=e_(async(e,t,s)=>{let r=await ex.aggregate([{$match:{ratingsAverage:{$gte:4.4}}},{$group:{_id:{$toUpper:"$difficulty"},num:{$sum:1},numRatings:{$sum:"$ratingsQuantity"},avgPrice:{$avg:"$price"},minPrice:{$min:"$price"},maxPrice:{$max:"$price"}}}]);t.status(200).json({status:"success",data:{stats:r}})}),u=e_(async(e,t,s)=>{let r=1*e.params.year,a=await ex.aggregate([{$unwind:"$startDates"},{$match:{startDates:{$gte:new Date(`${r}-1-1`),$lte:new Date(`${r}-12-31`)}}},{$group:{_id:{$month:"$startDates"},sum:{$sum:1},tours:{$push:"$name"}}},{$addFields:{month:"$_id"}},{$project:{_id:0}},{$sort:{sum:-1}},{$limit:12}]);t.status(200).json({status:"success",results:a.length,data:{plan:a}})}),d=e_(async(e,t,s)=>{let r=await ex.findOne({slug:e.params.slug}).populate([{path:"reviews",select:"-tour"}]);if(!r)return s(new eh(`Tour with slug ${e.params.slug} doesnt exists!`,404));t.status(200).json({status:"success",data:{tour:r}})});var eO=ei.promisify,eT={};const eC=er.Schema({name:{type:String,trim:!0,required:[!0,"Name is required!"],minLength:[2,"Minimum length for name is 2 Characters"],maxLength:[20,"Maximum length for name is 20 Characters"]},email:{type:String,required:[!0,"Email is required!"],unique:!0,trim:!0,lowerCase:!0,validate:[eu.isEmail,"Please provide a valid email address"]},photo:{type:String,trim:!0},password:{type:String,required:[!0,"Password is required!"],minLength:[8,"Minimum length for password is 8 characters"],maxLength:[100,"Maximum length for password is 20 characters"],trim:!0,select:!1},role:{type:String,enum:["user","guide","lead-guide","admin"],default:"user"},passwordConfirm:{type:String,required:[!0,"Password is required!"],minLength:[8,"Minimum length for password is 8 characters"],maxLength:[20,"Maximum length for password is 20 characters"],trim:!0,validate:{validator:function(e){return this.password==e},message:"Password must match!"}},passwordChangedAt:{type:Date},passwordResetToken:String,passwordResetExpires:Date,active:{type:Boolean,default:!0,select:!1}});eC.pre("save",async function(e){if(!this.isModified("password"))return e();this.password=await ed.hash(this.password,12),this.passwordConfirm=void 0,e()}),eC.pre("save",async function(e){if(this.isModified("password")||this.isNew)return e();this.passwordChangedAt=Date.now()-5e3,e()}),eC.methods.correctPassword=async function(e,t){return await ed.compare(e,t)},eC.methods.changePasswordAfter=async function(e){return!!this.passwordChangedAt&&e<parseInt(this.passwordChangedAt.getTime()/1e3,10)},eC.methods.createPasswordResetToken=function(){let e=en.randomBytes(32).toString("hex");return this.passwordResetToken=en.createHash("sha-256").update(e).digest("hex"),this.passwordResetExpires=Date.now()+6e5,e},eC.methods.cryptToken=function(e){return en.createHash("sha-256").update(e).digest("hex")},eC.pre(/^find/,function(e){this.find({active:!0}),e()}),eT=er.model("User",eC);var eD={},eN=U.resolve(__dirname,"../../../utils"),eM=el.convert;eD=class{constructor(e,t){this.to=e.email,this.firstName=e.name.split(" ")[0],this.url=t,this.from=`Boris Dimitrijevic <${process.env.EMAIL_FROM}>`}createTransport(){var e;return"production"===process.env.ENV_NODE?e=ec.createTransport({host:"",port:"",auth:{user:"",pass:""}}):e=ec.createTransport({host:"sandbox.smtp.mailtrap.io",port:2525,auth:{user:"e2f3c47e010096",pass:"a86b71d0b84b74"}}),e}async send(e,t){let s=em.renderFile(`${eN}/../views/email/${e}.pug`,{firstName:this.firstName,url:this.url,subject:t}),r={from:this.from,to:this.to,html:s,subject:t,text:eM(s)};await this.createTransport().sendMail(r)}async sendWelcome(){await this.send("welcome","Welcome to the Tours family!")}async sendPasswordReset(){await this.send("passwordReset",`Forgot your password? 
       Visit link:  ${this.url}
If u didnt forget your password please ignore this email`)}};const eA=e=>eo.sign({id:e},process.env.JWT_SECRET,{expiresIn:process.env.JWT_EXPIRES_IN}),eB=(e,t,s)=>{e.password=void 0;let r=eA(e._id),a={secure:!1,httpOnly:!0,expire:Date.now()+process.env.JWT_EXPIRES_IN||864e5};s.cookie("jwt",r,a),s.status(t).json({status:"success",token:r,user:e})};g=e_(async(e,t,s)=>{let r=await eT.create({name:e.body.name,password:e.body.password,passwordConfirm:e.body.passwordConfirm,email:e.body.email});if(!r)return s(new eh("Fail to signup!",400));let a=`${e.protocol}://${e.get("host")}://account`;await new eD(r,a).sendWelcome(),eB(r,201,t)}),h=e_(async(e,t,s)=>{let{email:r,password:a}=e.body;if(!r||!a)return s(new eh("Please provide email and password",400));let i=await eT.findOne({email:r}).select("+password");if(!i||!await i.correctPassword(a,i.password))return s(new eh("Invalid email or password",401));eB(i,200,t)}),w=e_(async(e,t,s)=>{let r;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")?r=e.headers.authorization.split(" ")[1]:e.cookies.jwt&&(r=e.cookies.jwt),!r)return s(new eh("Invalid token",401));let a=await eO(eo.verify)(r,process.env.JWT_SECRET),i=await eT.findById(a.id);return i?await i.changePasswordAfter(a.iat)?s(new eh("Recently password has been changed! Please login again! ",401)):void(e.user=i,s()):s(new eh("The user belonging to the token doesnt not exists anymore!",401))}),y=(...e)=>(t,s,r)=>{if(!e.includes(t.user.role))return r(new eh("You dont have permission to peform this action!",403),403);r()},f=e_(async(e,t,s)=>{let r=await eT.findOne({email:e.body.email});if(!r)return s(new eh("Wrong email adress!"),404);let a=r.createPasswordResetToken();await r.save({validateBeforeSave:!1});try{let t=`${e.get("origin")}/forgotPassword/${a}`;await new eD(r,t).sendPasswordReset()}catch(e){return r.passwordResetToken=void 0,r.passwordResetExpires=void 0,await r.save({validateBeforeSave:!1}),s(new eh("There was an error sending the email. Please try again",500))}t.status(200).json({status:"success",message:"Token sent to email"})}),v=e_(async(e,t,s)=>{let r=en.createHash("sha-256").update(e.params.token).digest("hex"),a=await eT.findOne({passwordResetToken:r,passwordResetExpires:{$gt:Date.now()}});if(!a)return s(new eh("Invalid token recived!",400));let{password:i,passwordConfirm:o}=e.body;a.passwordResetExpires=void 0,a.passwordResetToken=void 0,a.password=i,a.passwordConfirm=o,await a.save(),eB(a,200,t)}),q=e_(async(e,t,s)=>{let{oldPassword:r,password:a,passwordConfirm:i}=e.body,o=await eT.findById(e.user._id).select("+password");await e.user.correctPassword(r,o.password)||s(new eh("Invalid password!",400)),o.password=a,o.passwordConfirm=i,await o.save(),eB(o,200,t)}),b=e_(async(e,t,s)=>{t.cookie("jwt","",{expires:new Date(0)}),t.status(200).json({status:"success",message:"Successfully logged out"})});var eF={},eW={};const eL=er.Schema({review:{type:String,trim:!0,required:[!0,"Review is required"],minLength:[10,"Minimum length is 10 characters"]},rating:{type:Number,required:[!0,"Rating is required"],min:[1,"Minimum value is 1"],max:[5,"Minimum value is 5"]},createdAt:{type:Date,default:Date.now()},tour:{type:er.Schema.ObjectId,ref:"Tour",required:[!0,"Review must belong to a tour"]},user:{type:er.Schema.ObjectId,ref:"User",required:[!0,"Review must belong to a user"]}},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});eL.index({tour:1,user:1},{unique:!0}),eL.pre(/^find/,function(e){this.populate([{path:"user",select:"name photo"},{path:"tour",select:"name"}]).select("-__v"),e()}),eL.statics.calculateAverageRating=async function(e){let t=await this.aggregate([{$match:{tour:e}},{$group:{_id:"$tour",numberOfRatings:{$sum:1},avgRating:{$avg:"$rating"}}}]);await ex.findByIdAndUpdate(e,{ratingsQuantity:t[0]?.numberOfRatings||0,averageRating:t[0]?.avgRating||0})},eL.post("save",async function(){this.constructor.calculateAverageRating(this.tour)}),eL.post(/^findOneAnd/,async function(e){console.log(e),e&&await e.constructor.calculateAverageRating(e?.tour._id)}),$=m(eW=er.model("Review",eL)),j=l(eW),k=e_(async(e,t,s)=>{let r=e.query?.limit||6,a=e.query?.page||1,i=await eW.find().skip((a-1)*r).limit(r).populate([{path:"user",select:" email name photo"}]),o=await eW.countDocuments();t.status(200).json({status:"success",results:i.length,totalPages:Math.ceil(o/e.query.limit||6),data:{documents:i}})}),x=e_(async(e,t,s)=>{await ex.findOne({_id:e.params.tourId||e?.body.tourId})||s(new eh("Invalid id for tour!",404));let r={user:e.user.id,tour:e.params.tourId||e.body.tourId,rating:e.body.rating,review:e.body.review},a=await eW.create(r);t.status(201).json({status:"success",data:{review:a}})}),S=e_(async(e,t,s)=>{let r=e.query?.limit||6,a=e.query?.page||1,i=await eW.find({user:e.user.id}).limit(r).skip((a-1)*r),o=await eW.countDocuments({user:e.user.id});t.status(200).json({status:"success",results:o,totalPages:Math.ceil(o/r),data:{documents:i}})}),_=e_(async(e,t,s)=>{let r=await eW.findById(e.params.id);return r?"admin"!==e.user.role&&r.user!==e.user.id?s(new eh("You are not allowed to delete this review!",400)):(await eW.deleteOne({_id:r._id}),void t.status(204).json({status:"success"})):s(new eh("Review doesnt exists!"),404)});const eU=V.Router({mergeParams:!0});eU.route("/").get(w,y("admin"),k).post(w,x),eU.get("/me",w,S),eU.route("/:id").delete(w,_).patch(w,$).get(j),eF=eU;const eV=V.Router();eV.use("/:tourId/reviews",eF),eV.get("/slug/:slug/",d),eV.route("/top-5-cheap").get(o,a),eV.route("/tour-stats").get(n),eV.route("/monthly-plan/:year").get(w,y("admin","lead-guide","guide"),u),eV.route("/").get(a).post(w,y("admin","lead-guide"),i).patch(w,y("admin","lead-guide"),e,t,i),eV.route("/:id").get(r).delete(w,y("admin","lead-guide","user"),s),ek=eV;var ez={};const eJ=es.memoryStorage();R=es({storage:eJ,fileFilter:(e,t,s)=>{t.mimetype.startsWith("image")?s(null,!0):s(new eh("Not an image! Please upload only images!",400),!1)}}).single("photo"),I=e_(async(e,t,s)=>{if(!e.file)return s();e.file.filename=`${e.user.id}-${Date.now()}.jpeg`,await et(e.file.buffer).resize(500,500).toFormat("jpeg").jpeg({quality:90}).toFile(`public/img/users/${e.file.filename}`),s()});const eQ=(e,...t)=>{let s={};return Object.keys(e).forEach(r=>{t.includes(r)&&(s[r]=e[r])}),s};P=p(eT),E=m(eT),O=c(eT),T=l(eT),C=(e,t,s)=>{e.query.role="guide",s()},D=(e,t,s)=>{e.params.id=e.user.id,s()},N=e_(async(e,t,s)=>{await eT.findByIdAndDelete(e.user.id),t.status(204).json({stats:"success",data:null})}),M=e_(async(e,t,s)=>{if(e.body.password)return s(new eh("User password not allowed to change in this request!",400));let r=eQ(e.body,"name","email");e.file&&(r.photo=e.file.filename);let a=await eT.findByIdAndUpdate(e.user._id,r,{new:!0,runValidators:!0});t.status(200).json({stats:"success",data:{user:a}})});const eG=V.Router();eG.post("/signup",g),eG.post("/login",h),eG.post("/passwordForgot",f),eG.patch("/resetPassword/:token",v),eG.patch("/updatePassword",w,q),eG.use(w),eG.get("/guides",C,P),eG.get("/me",D,T),eG.post("/logout",b),eG.patch("/updateMe",R,I,M),eG.delete("/deleteMe",N),eG.use(y("lead-guide","admin")),eG.route("/").get(P),eG.route("/:id").get(T).patch(E).delete(O),ez=eG;var eH={};const eY=ep("sk_test_51PHRqMBN6CjUTslEk0VW2yNGfEnxS4QB1sSG6RbYVd6oPJl1rhoA4mMeUVB5v68xaSyKp5kW50y3i7O45sVPsdNe00SKtQ7zC3");var eK={};const eX=er.Schema({tour:{type:er.Schema.ObjectId,ref:"Tour",required:[!0,"Booking must belong to tour!"]},user:{type:er.Schema.ObjectId,ref:"User",required:[!0,"Booking must belong to user!"]},price:{type:Number,required:[!0,"Booking must have a price!"]},createdAt:{type:Date,default:Date.now()},paid:{type:Boolean,required:[!0,"Bookign must have information is it paid!"],default:!0}},{toJson:{virtuals:!0},toObject:{virtuals:!0}});eX.pre(/^find/,function(e){this.populate([{path:"tour"},{path:"user",select:"photo _id name email"}]),e()}),eK=er.model("Booking",eX),A=e_(async(e,t,s)=>{let r=await ex.findById(e.params.tourId);if(!r)return s(new eh(`Tour with id ${e.params.tourId} doesnt exists!`,400));let a=await eY.checkout.sessions.create({payment_method_types:["card"],mode:"payment",success_url:"http://localhost:5173/account/bookings?payment=success",cancel_url:"http://localhost:5173/account/bookings?payment=error",customer_email:e.user.email,client_reference_id:e.params.tourId,line_items:[{price_data:{currency:"usd",product_data:{name:`${r.name} Tour`,description:r.summary,images:["https://www.natours.dev/img/tours/tour-2-cover.jpg"]},unit_amount:100*r.price},quantity:1}]});t.status(200).json({status:"success",session:a})}),B=e_(async(e,t,s)=>{let{user:r,tour:a,price:i}=e.body;if(!r||!a||!i)return s(new eh("Missing body parts!",400));let o=await eK.create({user:r,tour:a,price:i});if(!o)return s(new eh("Fail to create booking",400));t.status(201).json({status:"success",data:{booking:o}})}),F=e_(async(e,t,s)=>{let r=await eK.find({user:e.user.id}).limit(e.query.limit).skip(e.query.page*e.query.limit),a=await eK.countDocuments({user:e.user.id});t.status(200).json({status:"success",results:r,totalPages:Math.ceil(a/r?.length),data:{bookings:r}})}),W=p(eK),L=c(eK);const eZ=V.Router();eZ.get("/checkout-session/:tourId",w,A),eZ.post("/create-checkout-booking",w,B),eZ.get("/all",w,y("admin","lead-guide"),W),eZ.delete("/:id",w,y("admin"),L),eZ.get("/",w,F),eH=eZ;const e0=V();e0.use(X({origin:"http://localhost:5173",credentials:!0})),e0.options("*",X()),J.config({path:"./config.env"});const e1=Q({max:100,windowMs:6e5,message:"Too many requests from this IP, please try again in 10 minutes!"});e0.use("/api",e1),e0.use(V.json({limit:"10kb"})),e0.use("/images",V.static(U.join(eg,"public","img","tours"))),e0.use("/images/user",V.static(U.join(eg,"public","img","users"))),e0.use(Z()),e0.use(G()),e0.use(H()),e0.use(Y()),e0.use(K({whitelist:["duration","ratingsQuantity","ratingsAverage","maxGroupSize","difficulty","price"]})),e0.use(ee()),"development"==process.env.ENV_NODE&&e0.use(z("dev")),e0.use("/api/v1/users/",ez),e0.use("/api/v1/tours/",ek),e0.use("/api/v1/reviews/",eF),e0.use("/api/v1/bookings/",eH),e0.all("*",(e,t,s)=>{s(new eh(`There is no path for ${e.originalUrl}`,404))}),e0.use(ew),module.exports=e0;
//# sourceMappingURL=app.js.map
